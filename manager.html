<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager - Z-Bridges PMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase Compat SDKs (Maintained for Fidelity with Existing app.js) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-item.active { background-color: #1e293b; color: #f8fafc; border-left: 4px solid #3b82f6; }
        .crm-card { transition: all 0.2s; border-left: 4px solid transparent; }
        .crm-card:hover { transform: translateX(4px); background-color: #f8fafc; }
        .crm-card.lead { border-left-color: #3b82f6; }
        .crm-card.tenant { border-left-color: #10b981; }
        .crm-card.owner { border-left-color: #8b5cf6; }
        .crm-card.vendor { border-left-color: #f59e0b; }
        
        .status-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; }
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
        .status-urgent { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-slate-900 text-slate-400 flex flex-col shadow-2xl z-30">
        <div class="h-16 flex items-center gap-3 px-6 border-b border-slate-800 bg-slate-950">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/20">Z</div>
            <span class="font-bold text-white tracking-tight">Z-BRIDGES ADMIN</span>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <div class="text-[10px] font-bold uppercase text-slate-600 mb-2 px-2 tracking-widest">General</div>
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-dashboard">
                <i class="fas fa-chart-line w-5"></i> Dashboard
            </button>
            <button onclick="router('properties')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-properties">
                <i class="fas fa-city w-5"></i> Properties
            </button>
            
            <div class="text-[10px] font-bold uppercase text-slate-600 mt-6 mb-2 px-2 tracking-widest">Relationships</div>
            <button onclick="router('leads')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-leads">
                <i class="fas fa-funnel-dollar w-5"></i> Lead Pipeline
            </button>
            <button onclick="router('directory')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-directory">
                <i class="fas fa-users-cog w-5"></i> Directory (CRM)
            </button>

            <div class="text-[10px] font-bold uppercase text-slate-600 mt-6 mb-2 px-2 tracking-widest">Operations</div>
            <button onclick="router('maintenance')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-maintenance">
                <i class="fas fa-tools w-5"></i> Work Orders
            </button>
            <button onclick="router('marketing')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-marketing">
                <i class="fas fa-bullhorn w-5"></i> Marketing / ILS
            </button>
            <button onclick="router('finance')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-finance">
                <i class="fas fa-file-invoice-dollar w-5"></i> Bookkeeping
            </button>
            
            <div class="pt-6 mt-6 border-t border-slate-800">
                <button onclick="router('system')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all text-sm font-medium group" id="nav-system">
                    <i class="fas fa-cloud-meatball w-5"></i> System & Cloud
                </button>
            </div>
        </nav>

        <div class="p-4 bg-slate-950 border-t border-slate-800 flex items-center gap-3">
            <div id="user-avatar" class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-sm text-white font-bold">ZB</div>
            <div class="overflow-hidden">
                <p class="text-white text-sm font-semibold truncate" id="admin-name">Admin User</p>
                <button onclick="handleLogout()" class="text-slate-500 text-xs hover:text-red-400 flex items-center gap-1 mt-0.5">
                    <i class="fas fa-power-off"></i> Sign Out
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Persistent Top Header -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 z-20 shrink-0">
            <div class="flex items-center gap-6">
                <h1 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h1>
                <div id="db-status-badge" class="flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full border border-slate-200">
                    <span class="w-2 h-2 rounded-full bg-slate-400" id="status-indicator"></span>
                    <span id="db-status-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">Initializing...</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <input type="text" placeholder="Global Search..." class="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500/20 w-64">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                </div>
                <button class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 relative">
                    <i class="far fa-bell"></i>
                    <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
            </div>
        </header>

        <!-- Dynamic Content Viewport -->
        <div id="app-content" class="flex-1 overflow-y-auto p-8 bg-slate-50/50 relative scroll-smooth">
            <!-- Renderers target this element -->
        </div>
    </main>

    <!-- Universal Modal System -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden fade-in">
            <!-- Injected by UI.modal() -->
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-[60] transform translate-y-32 transition-all duration-300 opacity-0">
        <div class="bg-slate-900 text-white px-5 py-3.5 rounded-xl shadow-2xl flex items-center gap-3 border border-slate-800">
            <div id="toast-icon-bg" class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                <i id="toast-icon" class="fas fa-info text-sm"></i>
            </div>
            <div>
                <p id="toast-message" class="text-sm font-medium">System Message</p>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        /**
         * GLOBAL STORE & INFRASTRUCTURE
         * Note: These would usually be in app.js, but logic is simplified here for fidelity and cross-module reference.
         */
        const Store = {
            data: {
                properties: [],
                units: [],
                leads: [],
                users: [], // Combined Directory for Tenants, Owners, Vendors
                ledger: [],
                tickets: [],
                listings: []
            },
            async init() {
                // Fetch logic would trigger here. Simulation for now:
                this.data.properties = [
                    { id: 1, name: 'Z-Bridges Plaza', address: '123 Tech Ave', status: 'Active', rent: 2500 },
                    { id: 2, name: 'Bridges Heights', address: '456 Innovation Blvd', status: 'Active', rent: 1800 }
                ];
                this.data.leads = [
                    { id: 'L1', name: 'John Doe', email: 'john@example.com', type: 'Tenant Prospect', status: 'New', propertyId: 1 },
                    { id: 'L2', name: 'Jane Smith', email: 'jane@realty.com', type: 'Owner Prospect', status: 'Contacted' }
                ];
                this.data.users = [
                    { id: 'U1', name: 'Alice Resident', email: 'alice@tenant.com', role: 'tenant', unit: 'A101', propertyId: 1 },
                    { id: 'U2', name: 'Bob Contractor', email: 'bob@repairs.com', role: 'vendor', skill: 'Plumbing' },
                    { id: 'U3', name: 'Charlie Owner', email: 'charlie@cap.com', role: 'owner', properties: [1, 2] }
                ];
                this.data.tickets = [
                    { id: 'T1', title: 'Leaky Faucet', unit: 'A101', priority: 'High', status: 'Open', vendorId: 'U2' }
                ];
                this.data.ledger = [
                    { id: 'F1', date: '2023-10-01', desc: 'Rent Payment - Alice', amount: 2500, type: 'Credit', category: 'Rent' }
                ];
                
                updateConnectionStatus('cloud');
            }
        };

        const Infrastructure = {
            mode: 'local', // fallback
            gasUrl: localStorage.getItem('z-bridgesGAS') || '',
            setMode(m) { this.mode = m; }
        };

        // UI Engine
        const UI = {
            modal(html) {
                const modal = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = html;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            },
            closeModal() {
                const modal = document.getElementById('modal-overlay');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            },
            toast(msg, type = 'info') {
                const t = document.getElementById('toast');
                const msgEl = document.getElementById('toast-message');
                const iconBg = document.getElementById('toast-icon-bg');
                
                msgEl.innerText = msg;
                if(type === 'success') iconBg.className = 'w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center';
                else if(type === 'error') iconBg.className = 'w-8 h-8 rounded-lg bg-red-500 flex items-center justify-center';
                else iconBg.className = 'w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center';
                
                t.classList.remove('translate-y-32', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
            }
        };

        function updateConnectionStatus(mode) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('db-status-text');
            const badge = document.getElementById('db-status-badge');
            
            Infrastructure.setMode(mode);
            if(mode === 'cloud') {
                indicator.className = 'w-2 h-2 rounded-full bg-green-500 shadow-sm';
                text.innerText = 'Cloud Sync Active';
                badge.classList.add('bg-green-50', 'border-green-200');
            } else {
                indicator.className = 'w-2 h-2 rounded-full bg-orange-500';
                text.innerText = 'Local Storage Mode';
            }
        }

        // --- ROUTING SYSTEM ---
        function router(view) {
            // UI State updates
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${view}`);
            if(activeNav) activeNav.classList.add('active');

            const pageTitleMap = {
                dashboard: 'Overview',
                properties: 'Portfolio Manager',
                leads: 'Sales & Conversion',
                directory: 'Relationship Database',
                maintenance: 'Operations & Maintenance',
                marketing: 'Marketing & ILS',
                finance: 'Financial Ledger',
                system: 'Infrastructure Config'
            };

            document.getElementById('page-title').innerText = pageTitleMap[view] || 'Admin';
            const viewport = document.getElementById('app-content');
            viewport.innerHTML = `<div class="flex h-full items-center justify-center text-slate-400"><i class="fas fa-spinner fa-spin text-2xl"></i></div>`;

            setTimeout(() => {
                switch(view) {
                    case 'dashboard': renderDashboard(viewport); break;
                    case 'properties': renderProperties(viewport); break;
                    case 'leads': renderLeads(viewport); break;
                    case 'directory': renderDirectory(viewport); break;
                    case 'maintenance': renderMaintenance(viewport); break;
                    case 'marketing': renderMarketing(viewport); break;
                    case 'finance': renderFinance(viewport); break;
                    case 'system': renderSystem(viewport); break;
                    default: viewport.innerHTML = `Not Found`;
                }
            }, 150);
        }

        // --- COMPONENT RENDERERS ---

        function renderDashboard(el) {
            const stats = {
                revenue: Store.data.ledger.filter(l => l.type === 'Credit').reduce((a,b) => a + b.amount, 0),
                leads: Store.data.leads.length,
                tickets: Store.data.tickets.filter(t => t.status === 'Open').length
            };

            el.innerHTML = `
                <div class="fade-in space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Revenue (YTD)</p>
                            <h3 class="text-3xl font-bold text-slate-800">$${stats.revenue.toLocaleString()}</h3>
                            <div class="mt-4 h-1 bg-blue-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500 w-2/3"></div></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Active Leads</p>
                            <h3 class="text-3xl font-bold text-slate-800">${stats.leads}</h3>
                            <p class="text-xs text-green-600 font-bold mt-2"><i class="fas fa-caret-up"></i> +12% this week</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Open Work Orders</p>
                            <h3 class="text-3xl font-bold ${stats.tickets > 0 ? 'text-red-500' : 'text-slate-800'}">${stats.tickets}</h3>
                            <p class="text-xs text-slate-400 mt-2">${stats.tickets === 0 ? 'All systems clear' : 'Requires attention'}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-bold text-slate-700">Financial Growth</h4>
                                <select class="text-xs border-none bg-slate-100 rounded-lg px-2 py-1">
                                    <option>Last 6 Months</option>
                                </select>
                            </div>
                            <canvas id="mainChart" height="200"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h4 class="font-bold text-slate-700 mb-6">Recent Activity</h4>
                            <div class="space-y-6">
                                ${[1,2,3].map(() => `
                                    <div class="flex gap-4">
                                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 text-xs shrink-0"><i class="fas fa-bell"></i></div>
                                        <div class="overflow-hidden">
                                            <p class="text-sm font-medium text-slate-800">Lead Conversion</p>
                                            <p class="text-xs text-slate-500 truncate">John Doe moved to Unit B204</p>
                                            <p class="text-[10px] text-slate-400 mt-1">2 hours ago</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            initDashboardChart();
        }

        function initDashboardChart() {
            const ctx = document.getElementById('mainChart');
            if(!ctx) return;
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov'],
                    datasets: [{
                        label: 'Gross Income',
                        data: [12000, 15000, 14000, 18000, 19000, 22000],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { grid: { display: false }, border: { display: false }, ticks: { display: false } },
                        x: { grid: { display: false }, border: { display: false } }
                    }
                }
            });
        }

        // --- RELATIONSHIPS: LEAD PIPELINE ---
        function renderLeads(el) {
            const leads = Store.data.leads;
            el.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Lead Pipeline</h2>
                            <p class="text-sm text-slate-500">Track prospects through the sales funnel.</p>
                        </div>
                        <button onclick="showAddLeadModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> Add New Prospect
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl">
                            <p class="text-[10px] font-bold text-blue-500 uppercase">New Leads</p>
                            <p class="text-2xl font-bold text-blue-900">${leads.filter(l => l.status === 'New').length}</p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl">
                            <p class="text-[10px] font-bold text-yellow-600 uppercase">In Discussion</p>
                            <p class="text-2xl font-bold text-yellow-900">${leads.filter(l => l.status === 'Contacted').length}</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-100 p-4 rounded-xl">
                            <p class="text-[10px] font-bold text-purple-600 uppercase">Ready to Sign</p>
                            <p class="text-2xl font-bold text-purple-900">0</p>
                        </div>
                        <div class="bg-green-50 border border-green-100 p-4 rounded-xl">
                            <p class="text-[10px] font-bold text-green-600 uppercase">Conversions</p>
                            <p class="text-2xl font-bold text-green-900">0</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase">Prospect</th>
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase">Interest Type</th>
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase">Status</th>
                                    <th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${leads.map(l => `
                                    <tr class="crm-card lead group hover:bg-slate-50/50">
                                        <td class="px-6 py-4">
                                            <p class="font-bold text-slate-800">${l.name}</p>
                                            <p class="text-xs text-slate-400">${l.email}</p>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 bg-slate-100 rounded text-[10px] font-bold text-slate-600">${l.type}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-2">
                                                <div class="w-2 h-2 rounded-full ${l.status === 'New' ? 'bg-blue-500' : 'bg-yellow-500'}"></div>
                                                <span class="text-xs font-semibold text-slate-600">${l.status}</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button onclick="showConvertModal('${l.id}')" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold hover:bg-green-200 transition">
                                                Convert to Client
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- RELATIONSHIPS: DIRECTORY ---
        function renderDirectory(el) {
            const users = Store.data.users;
            const tenants = users.filter(u => u.role === 'tenant');
            const owners = users.filter(u => u.role === 'owner');
            const vendors = users.filter(u => u.role === 'vendor');

            el.innerHTML = `
                <div class="fade-in h-full flex flex-col">
                    <div class="flex justify-between items-center mb-8 shrink-0">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Contact Directory</h2>
                            <p class="text-sm text-slate-500">Master database of all active relationships.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 flex-1 overflow-hidden min-h-0 pb-4">
                        <!-- Tenants Column -->
                        <div class="bg-white rounded-2xl border border-slate-200 flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    <i class="fas fa-home text-blue-500"></i> Leases / Tenants
                                    <span class="px-2 py-0.5 bg-white border rounded-full text-[10px] text-slate-400 font-mono">${tenants.length}</span>
                                </h3>
                                <button onclick="showAddUserModal('tenant')" class="w-6 h-6 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-400"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                ${tenants.map(u => renderContactItem(u)).join('')}
                            </div>
                        </div>

                        <!-- Owners Column -->
                        <div class="bg-white rounded-2xl border border-slate-200 flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    <i class="fas fa-crown text-purple-500"></i> Clients / Owners
                                    <span class="px-2 py-0.5 bg-white border rounded-full text-[10px] text-slate-400 font-mono">${owners.length}</span>
                                </h3>
                                <button onclick="showAddUserModal('owner')" class="w-6 h-6 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-400"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                ${owners.map(u => renderContactItem(u)).join('')}
                            </div>
                        </div>

                        <!-- Vendors Column -->
                        <div class="bg-white rounded-2xl border border-slate-200 flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                    <i class="fas fa-hard-hat text-orange-500"></i> Vendors / Contractors
                                    <span class="px-2 py-0.5 bg-white border rounded-full text-[10px] text-slate-400 font-mono">${vendors.length}</span>
                                </h3>
                                <button onclick="showAddUserModal('vendor')" class="w-6 h-6 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-400"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                ${vendors.map(u => renderContactItem(u)).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContactItem(u) {
            return `
                <div class="crm-card ${u.role} p-3 rounded-xl flex items-center gap-3 cursor-pointer group hover:bg-slate-50 transition relative">
                    <div class="w-9 h-9 rounded-lg bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500 group-hover:bg-white transition">${u.name.charAt(0)}</div>
                    <div class="overflow-hidden flex-1">
                        <p class="text-sm font-bold text-slate-800 truncate">${u.name}</p>
                        <p class="text-[10px] text-slate-400 truncate">${u.email}</p>
                        ${u.role === 'vendor' ? `<p class="text-[9px] font-bold text-orange-600 uppercase mt-0.5 tracking-tighter">${u.skill}</p>` : ''}
                    </div>
                    <div class="opacity-0 group-hover:opacity-100 flex gap-1">
                        <button class="w-6 h-6 rounded bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-blue-500 transition"><i class="fas fa-eye text-[10px]"></i></button>
                    </div>
                </div>
            `;
        }

        // --- OPERATIONS: MAINTENANCE ---
        function renderMaintenance(el) {
            const tickets = Store.data.tickets;
            el.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Work Orders</h2>
                            <p class="text-sm text-slate-500">Dispatch and track maintenance requests.</p>
                        </div>
                        <button onclick="showNewTicketModal()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-xl hover:bg-slate-800 transition flex items-center gap-2">
                            <i class="fas fa-tools"></i> Create Work Order
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${tickets.map(t => {
                            const vendor = Store.data.users.find(u => u.id === t.vendorId);
                            return `
                                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div class="flex items-center gap-4 flex-1">
                                        <div class="w-12 h-12 rounded-xl ${t.priority === 'High' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'} flex items-center justify-center shrink-0">
                                            <i class="fas fa-wrench"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-800">${t.title}</h4>
                                            <p class="text-xs text-slate-500">Location: <span class="font-bold text-slate-700">${t.unit}</span> | Assigned To: <span class="text-blue-600 font-medium">${vendor ? vendor.name : 'Unassigned'}</span></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="status-badge ${t.priority === 'High' ? 'status-urgent' : 'status-active'}">${t.priority} Priority</span>
                                        <button class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-bold transition">Manage</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- PORTFOLIO: PROPERTIES ---
        function renderProperties(el) {
            const props = Store.data.properties;
            el.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Property Portfolio</h2>
                            <p class="text-sm text-slate-500">Active assets and unit inventory.</p>
                        </div>
                        <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:bg-blue-700 transition">
                            <i class="fas fa-building-circle-plus"></i> Add Property
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${props.map(p => `
                            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all group">
                                <div class="h-40 bg-slate-200 relative">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                    <div class="absolute bottom-4 left-4">
                                        <p class="text-white font-bold text-lg">${p.name}</p>
                                        <p class="text-white/80 text-xs">${p.address}</p>
                                    </div>
                                    <span class="absolute top-4 right-4 px-3 py-1 bg-green-500 text-white text-[10px] font-bold rounded-full">ACTIVE</span>
                                </div>
                                <div class="p-5">
                                    <div class="flex justify-between items-center mb-4">
                                        <div><p class="text-[10px] text-slate-400 font-bold uppercase">Base Rent</p><p class="font-bold text-slate-800">$${p.rent}/mo</p></div>
                                        <div><p class="text-[10px] text-slate-400 font-bold uppercase text-right">Occupancy</p><p class="font-bold text-blue-600 text-right">98%</p></div>
                                    </div>
                                    <div class="pt-4 border-t border-slate-100 flex justify-between">
                                        <button class="text-blue-600 text-xs font-bold hover:underline">View Details</button>
                                        <button class="text-slate-400 hover:text-slate-600"><i class="fas fa-ellipsis-h"></i></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- SYSTEM: SETTINGS ---
        function renderSystem(el) {
            el.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto space-y-6">
                    <div class="text-center mb-10">
                        <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto mb-4 flex items-center justify-center text-white text-2xl"><i class="fas fa-microchip"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">System Configuration</h2>
                        <p class="text-sm text-slate-500">Z-Bridges PMS Infrastructure Controller</p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center shrink-0"><i class="fas fa-database"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800">Cloud Sync (Firebase)</h4>
                                <p class="text-xs text-slate-500">Real-time collaboration across multiple devices.</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <span class="text-sm font-medium text-slate-700">Storage Environment</span>
                            <span class="px-3 py-1 bg-green-100 text-green-700 text-[10px] font-bold rounded-lg uppercase">Cloud Connected</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-xl bg-green-50 text-green-600 flex items-center justify-center shrink-0"><i class="fas fa-bolt"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800">Automation Webhooks</h4>
                                <p class="text-xs text-slate-500">Google Apps Script bridge for emails and notifications.</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">GAS Webhook URL</label>
                            <div class="flex gap-2">
                                <input id="gas-url" type="text" value="${Infrastructure.gasUrl}" class="flex-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500/20" placeholder="https://script.google.com/macros/s/...">
                                <button onclick="saveSystemSettings()" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- MODAL DIALOGS & LOGIC ---

        function showAddLeadModal() {
            UI.modal(`
                <div class="px-8 py-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Add New Prospect</h3>
                        <button onclick="UI.closeModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Full Name</label>
                                <input id="l-name" type="text" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm" placeholder="John Doe">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Interest Type</label>
                                <select id="l-type" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm">
                                    <option>Tenant Prospect</option>
                                    <option>Owner Prospect</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Email Address</label>
                            <input id="l-email" type="email" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm" placeholder="john@example.com">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Source Property</label>
                            <select id="l-prop" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm">
                                ${Store.data.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="saveNewLead()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-xl shadow-blue-500/20 hover:bg-blue-700 mt-4 transition">Create Prospect Record</button>
                    </div>
                </div>
            `);
        }

        function showConvertModal(leadId) {
            const lead = Store.data.leads.find(l => l.id === leadId);
            if(!lead) return;

            UI.modal(`
                <div class="px-8 py-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Convert Pipeline Lead</h3>
                        <button onclick="UI.closeModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                        <p class="text-xs text-blue-700 font-medium">Converting <strong>${lead.name}</strong> to a permanent database record.</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Select Destination Role</label>
                            <select id="c-role" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm">
                                <option value="tenant" ${lead.type.includes('Tenant') ? 'selected' : ''}>Tenant (Resident)</option>
                                <option value="owner" ${lead.type.includes('Owner') ? 'selected' : ''}>Client (Property Owner)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Assign to Unit/Property</label>
                            <select id="c-prop" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm">
                                ${Store.data.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Workflow Actions</p>
                            <div class="flex items-center gap-3 mb-2">
                                <input type="checkbox" checked class="rounded text-blue-600">
                                <span class="text-xs text-slate-600">Create login credentials</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" checked class="rounded text-blue-600">
                                <span class="text-xs text-slate-600">Notify assigned manager</span>
                            </div>
                        </div>
                        <button onclick="executeConversion('${lead.id}')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-sm shadow-xl shadow-green-500/20 hover:bg-green-700 mt-4 transition">Finalize Migration</button>
                    </div>
                </div>
            `);
        }

        function showAddUserModal(role) {
            UI.modal(`
                <div class="px-8 py-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Add ${role.charAt(0).toUpperCase() + role.slice(1)}</h3>
                        <button onclick="UI.closeModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-4">
                        <input id="u-name" type="text" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm" placeholder="Full Name">
                        <input id="u-email" type="email" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm" placeholder="Email">
                        ${role === 'vendor' ? '<input id="u-skill" type="text" class="w-full px-4 py-2 bg-slate-100 rounded-lg border-none text-sm" placeholder="Specialization (e.g. Electrician)">' : ''}
                        <button onclick="saveNewUser('${role}')" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm shadow-xl hover:bg-slate-800 mt-4 transition">Add to Directory</button>
                    </div>
                </div>
            `);
        }

        // --- ACTION HANDLERS ---

        function saveNewLead() {
            const name = document.getElementById('l-name').value;
            const email = document.getElementById('l-email').value;
            const type = document.getElementById('l-type').value;
            const propId = document.getElementById('l-prop').value;

            if(!name || !email) return UI.toast('Please fill all fields', 'error');

            const newLead = { id: Date.now().toString(), name, email, type, status: 'New', propertyId: parseInt(propId) };
            Store.data.leads.push(newLead);
            UI.closeModal();
            UI.toast('Prospect Captured Successfully', 'success');
            router('leads');
        }

        function executeConversion(leadId) {
            const lead = Store.data.leads.find(l => l.id === leadId);
            const role = document.getElementById('c-role').value;
            const propId = document.getElementById('c-prop').value;

            if(lead) {
                // Add to Directory
                const newUser = {
                    id: 'U' + Date.now(),
                    name: lead.name,
                    email: lead.email,
                    role: role,
                    propertyId: parseInt(propId)
                };
                Store.data.users.push(newUser);
                
                // Remove from Leads
                Store.data.leads = Store.data.leads.filter(l => l.id !== leadId);
                
                UI.closeModal();
                UI.toast(`Migrated ${lead.name} to ${role} database`, 'success');
                router('directory');
            }
        }

        function saveNewUser(role) {
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const skill = document.getElementById('u-skill')?.value;

            if(!name || !email) return UI.toast('All fields required', 'error');

            const newUser = { id: 'U' + Date.now(), name, email, role };
            if(skill) newUser.skill = skill;

            Store.data.users.push(newUser);
            UI.closeModal();
            UI.toast(`${role} added successfully`, 'success');
            router('directory');
        }

        function saveSystemSettings() {
            const url = document.getElementById('gas-url').value;
            Infrastructure.gasUrl = url;
            localStorage.setItem('z-bridgesGAS', url);
            UI.toast('Automation Webhook Synchronized', 'success');
        }

        function handleLogout() {
            UI.toast('Signing out safely...');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            Store.init().then(() => {
                router('dashboard');
            });
        };

    </script>
</body>
</html>
